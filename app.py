# app.py

import streamlit as st
import pandas as pd
import plotly.express as px
import google.generativeai as genai
import os

# --- 1. CONFIGURA√á√ÉO INICIAL E DE SEGURAN√áA ---

# =================================================================================
# ATEN√á√ÉO! ALERTA DE SEGURAN√áA!
# A sua chave API est√° inserida diretamente no c√≥digo abaixo.
# Isto √© APENAS PARA TESTES LOCAIS.
# N√ÉO COMPARTILHE ESTE ARQUIVO COM NINGU√âM E N√ÉO O ENVIE PARA O GITHUB.
# Qualquer pessoa com esta chave pode us√°-la em seu nome.
# =================================================================================
SUA_CHAVE_API = "AIzaSyAXWKA9oEpsPu9UbzCFaiiThiAKOuLLN7o" 

# Configura a p√°gina do Streamlit
st.set_page_config(
    page_title="Dashboard de Vendas com IA",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Configura a API do Gemini com a chave inserida diretamente
if SUA_CHAVE_API and SUA_CHAVE_API != "SUA_CHAVE_API_AQUI":
    try:
        genai.configure(api_key=SUA_CHAVE_API)
        GEMINI_CONFIGURADO = True
    except Exception as e:
        st.error(f"Erro ao configurar a API do Gemini: {e}")
        GEMINI_CONFIGURADO = False
else:
    st.error("ERRO: A chave da API n√£o foi inserida no c√≥digo. Edite o arquivo app.py e substitua 'SUA_CHAVE_API_AQUI' pela sua chave real.")
    GEMINI_CONFIGURADO = False


# --- 2. FUN√á√ïES AUXILIARES ---

@st.cache_data # Cache para melhorar a performance
def carregar_dados(caminho_arquivo):
    """Carrega os dados de um arquivo CSV. Se o arquivo n√£o existir, cria um com dados de exemplo."""
    if not os.path.exists(caminho_arquivo):
        st.warning(f"Arquivo '{caminho_arquivo}' n√£o encontrado! Criando um com dados de exemplo.")
        dados_exemplo = {
            'Data': pd.to_datetime(['2025-08-04', '2025-08-05', '2025-08-06', '2025-08-07', '2025-08-08', '2025-08-11', '2025-08-12', '2025-08-13']),
            'Produto': ['Produto A', 'Produto B', 'Produto A', 'Produto C', 'Produto B', 'Produto A', 'Produto C', 'Produto B'],
            'Categoria': ['Eletr√¥nicos', 'Livros', 'Eletr√¥nicos', 'Casa', 'Livros', 'Eletr√¥nicos', 'Casa', 'Livros'],
            'Vendas': [1200, 150, 1800, 300, 250, 2200, 450, 210],
            'Regiao': ['Sudeste', 'Sul', 'Sudeste', 'Nordeste', 'Sul', 'Sudeste', 'Nordeste', 'Sul']
        }
        df = pd.DataFrame(dados_exemplo)
        df.to_csv(caminho_arquivo, index=False)
    
    df = pd.read_csv(caminho_arquivo)
    df['Data'] = pd.to_datetime(df['Data'])
    return df

# --- 3. CARREGAMENTO DOS DADOS E FILTROS ---

# Carrega os dados
df = carregar_dados('vendas.csv')

st.sidebar.title("Filtros Interativos")
regiao = st.sidebar.multiselect(
    "Selecione a Regi√£o:",
    options=df["Regiao"].unique(),
    default=df["Regiao"].unique()
)
categoria = st.sidebar.multiselect(
    "Selecione a Categoria:",
    options=df["Categoria"].unique(),
    default=df["Categoria"].unique()
)
df_filtrado = df[df["Regiao"].isin(regiao) & df["Categoria"].isin(categoria)]


# --- 4. LAYOUT DA DASHBOARD COM ABAS ---

st.title("üöÄ Dashboard Interativa com Gemini AI")
st.markdown("Use as abas abaixo para navegar entre a visualiza√ß√£o de dados e a an√°lise com Intelig√™ncia Artificial.")

tab1, tab2, tab3 = st.tabs(["üìä Resumo Visual", "ü§ñ An√°lise com IA", "üí¨ Pergunte aos Dados"])

# --- ABA 1: RESUMO VISUAL ---
with tab1:
    st.header("Principais Indicadores (KPIs)")
    col1, col2, col3 = st.columns(3)
    col1.metric("Vendas Totais", f"R$ {df_filtrado['Vendas'].sum():,.2f}")
    col2.metric("Ticket M√©dio", f"R$ {df_filtrado['Vendas'].mean():,.2f}")
    col3.metric("N¬∫ de Vendas", df_filtrado.shape[0])

    st.markdown("---")
    st.header("Visualiza√ß√µes Gr√°ficas")
    
    col_graf1, col_graf2 = st.columns(2)
    with col_graf1:
        st.subheader("Vendas por Categoria")
        fig_cat = px.bar(df_filtrado.groupby('Categoria')['Vendas'].sum().reset_index(), x='Categoria', y='Vendas')
        st.plotly_chart(fig_cat, use_container_width=True)
    with col_graf2:
        st.subheader("Vendas por Regi√£o")
        fig_reg = px.pie(df_filtrado.groupby('Regiao')['Vendas'].sum().reset_index(), names='Regiao', values='Vendas')
        st.plotly_chart(fig_reg, use_container_width=True)

# --- ABA 2: AN√ÅLISE COM IA ---
with tab2:
    st.header("An√°lise Qualitativa dos Dados com Gemini")
    st.markdown("Clique no bot√£o abaixo para que o Gemini gere um resumo executivo sobre os dados filtrados.")

    if st.button("Gerar Resumo Anal√≠tico", disabled=not GEMINI_CONFIGURADO):
        with st.spinner("Gemini est√° pensando... üß†"):
            # Prompt para o Gemini: instrui a IA a atuar como um analista de dados
            prompt = f"""
            Voc√™ √© um analista de dados s√™nior. Analise o resumo dos dados de vendas a seguir:
            Resumo estat√≠stico:
            {df_filtrado.describe().to_string()}
            
            Vendas por categoria:
            {df_filtrado.groupby('Categoria')['Vendas'].sum().to_string()}

            Com base nesses n√∫meros, escreva uma an√°lise curta (3 par√°grafos) com os principais insights,
            oportunidades e pontos de aten√ß√£o para uma reuni√£o de diretoria. Use um tom profissional e direto.
            """
            model = genai.GenerativeModel('gemini-1.5-flash')
            response = model.generate_content(prompt)
            st.markdown("---")
            st.subheader("An√°lise do Gemini:")
            st.markdown(response.text)
    elif not GEMINI_CONFIGURADO:
        st.warning("A funcionalidade de IA est√° desabilitada. Verifique a configura√ß√£o da sua chave API no topo do arquivo app.py.")

# --- ABA 3: PERGUNTE AOS DADOS ---
with tab3:
    st.header("Converse com seus Dados")
    st.markdown("Fa√ßa uma pergunta em linguagem natural sobre os dados. Exemplos: 'Qual produto vendeu mais?' ou 'qual a m√©dia de vendas da regi√£o sul?'")

    pergunta_usuario = st.text_input("Sua pergunta:", key="pergunta_ia")

    if pergunta_usuario and GEMINI_CONFIGURADO:
        with st.spinner("Gemini est√° consultando os dados para voc√™... üïµÔ∏è"):
            # Prompt avan√ßado: instrui a IA a traduzir a pergunta para c√≥digo Python
            prompt = f"""
            Voc√™ √© um expert em Pandas. O usu√°rio est√° trabalhando com um DataFrame chamado 'df_filtrado'
            com as seguintes colunas: {df_filtrado.columns.to_list()}.
            
            Converta a seguinte pergunta do usu√°rio em um √∫nico comando de c√≥digo Python que possa ser
            executado para encontrar a resposta. Retorne APENAS o c√≥digo, sem explica√ß√µes, sem `print()`,
            sem aspas ou formata√ß√£o de c√≥digo.
            
            Pergunta: "{pergunta_usuario}"
            C√≥digo Python:
            """
            model = genai.GenerativeModel('gemini-1.5-flash')
            response = model.generate_content(prompt)
            codigo_gerado = response.text.strip()
            
            st.markdown("---")
            st.write("üîç **Gemini interpretou sua pergunta e gerou o seguinte c√≥digo para encontrar a resposta:**")
            st.code(codigo_gerado, language='python')

            try:
                # ATEN√á√ÉO: Executar c√≥digo gerado dinamicamente √© um risco.
                # Para esta ferramenta de apresenta√ß√£o interna, √© aceit√°vel, mas requer cuidado.
                resultado = eval(codigo_gerado, {"df_filtrado": df_filtrado, "pd": pd})
                st.write("‚úÖ **Resultado:**")
                st.write(resultado)
            except Exception as e:
                st.error(f"N√£o foi poss√≠vel executar a consulta. O Gemini pode ter gerado um c√≥digo inv√°lido. Tente reformular a pergunta. Erro: {e}")

    elif pergunta_usuario and not GEMINI_CONFIGURADO:
        st.warning("A funcionalidade de IA est√° desabilitada. Verifique a configura√ß√£o da sua chave API no topo do arquivo app.py.")